<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω ‚Äî –ö–∞—Ä—Ç–∫–æ–≤–∞ –≥—Ä–∞</title>
  <style>
    :root {
      /* Fallbacks; –±—É–¥—É—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ñ –∑ Telegram themeParams */
      --bg: #0f1115;
      --text: #e7e9ee;
      --muted: #a3a9b6;
      --card: #151923;
      --accent: #2cab37;
      --danger: #e64646;
      --shadow: 0 8px 28px rgba(0,0,0,.25);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container { max-width: 1024px; margin: 0 auto; padding: 16px; }

    header {
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
      position: sticky; top: 0; z-index: 10; padding: 12px 0; backdrop-filter: blur(8px);
    }
    .title { font-size: 20px; font-weight: 700; }

    .tabs {
      display: grid; grid-auto-flow: column; gap: 8px; overflow-x: auto; padding-bottom: 8px;
    }
    .tab { border: 1px solid rgba(255,255,255,.08); padding: 8px 12px; border-radius: 999px; cursor: pointer; white-space: nowrap; color: var(--muted); background: rgba(255,255,255,.03); }
    .tab[aria-selected="true"] { color: var(--text); background: rgba(255,255,255,.08); border-color: transparent; }

    .grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 12px; }
    @media (min-width: 560px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 900px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

    .card {
      background: var(--card); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow);
      display: grid; grid-template-columns: 56px 1fr auto; align-items: center; gap: 12px;
    }
    .icon { font-size: 28px; }
    .name { font-weight: 700; font-size: 16px; }
    .desc { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .price { font-weight: 700; margin-top: 8px; }

    .btn {
      appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; cursor: pointer;
      background: rgba(255,255,255,.08); color: var(--text); font-weight: 600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-add { background: var(--accent); color: #fff; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,.12); color: var(--muted); }
    .btn-danger { background: var(--danger); color: #fff; }

    .cartbar {
      position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(15,17,21,0.4), var(--bg));
      padding: 12px 0 4px; margin-top: 12px;
    }
    .cart {
      background: var(--card); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow);
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .cart-info { display: flex; align-items: center; gap: 8px; }
    .badge { background: rgba(255,255,255,.1); padding: 6px 10px; border-radius: 999px; font-weight: 700; }

    .cart-items { margin-top: 8px; display: grid; gap: 8px; }
    .cart-row { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 8px; font-size: 14px; }
    .qty {
      display: inline-grid; grid-auto-flow: column; gap: 6px; align-items: center;
      border: 1px solid rgba(255,255,255,.12); border-radius: 10px; padding: 4px 6px;
    }
    .qty button { background: transparent; border: 0; color: var(--text); font-size: 18px; line-height: 1; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
      <button class="btn btn-ghost" id="btnRestore">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø–æ–∫—É–ø–∫–∏</button>
    </header>

    <nav class="tabs" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó">
      <button class="tab" role="tab" aria-selected="true" data-filter="all">–£—Å–µ</button>
      <button class="tab" role="tab" aria-selected="false" data-filter="resources">–†–µ—Å—É—Ä—Å–∏</button>
      <button class="tab" role="tab" aria-selected="false" data-filter="subs">–ü—ñ–¥–ø–∏—Å–∫–∏</button>
      <button class="tab" role="tab" aria-selected="false" data-filter="bundles">–ù–∞–±–æ—Ä–∏</button>
      <button class="tab" role="tab" aria-selected="false" data-filter="cosmetics">–ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
    </nav>

    <section class="grid" id="itemsGrid"></section>

    <div class="cartbar">
      <div class="cart">
        <div class="cart-info">
          <span class="badge" id="cartCount">0</span>
          <span id="cartSummary">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="price" id="cartTotal">$0.00</div>
          <button class="btn btn-danger" id="btnClear" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
      </div>
      <div class="cart-items" id="cartItems"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    // –¢–µ–º–∞ –∑ Telegram
    function applyTelegramTheme() {
      if (!tg || !tg.themeParams) return;
      const p = tg.themeParams;
      const map = (k, fb) => p[k] || fb;
      document.documentElement.style.setProperty('--bg', map('bg_color', '#0f1115'));
      document.documentElement.style.setProperty('--text', map('text_color', '#e7e9ee'));
      document.documentElement.style.setProperty('--card', map('secondary_bg_color', '#151923'));
      document.documentElement.style.setProperty('--muted', map('hint_color', '#a3a9b6'));
      document.documentElement.style.setProperty('--accent', map('button_color', '#2cab37'));
      document.documentElement.style.setProperty('--danger', '#e64646');
    }

    // –†–æ–∑—à–∏—Ä—é—î–º–æ WebApp, –≤–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
    function initTelegram() {
      if (!tg) return;
      tg.ready();
      tg.expand();
      tg.MainButton.setParams({ text: '–û–ø–ª–∞—Ç–∏—Ç–∏', color: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() });
      tg.MainButton.hide();
    }

    // –¢–æ–≤–∞—Ä–∏
    const PRODUCTS = [
      // –†–µ—Å—É—Ä—Å–∏
      { id: 'energy_50', name: '–ï–Ω–µ—Ä–≥—ñ—è (50)', price: 1.99, emoji: '‚ö°', desc: '–î–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –º–∞—Ç—á—ñ–≤', cat: 'resources' },
      { id: 'energy_150', name: '–ï–Ω–µ—Ä–≥—ñ—è (150)', price: 4.99, emoji: '‚ö°', desc: '–í–∏–≥—ñ–¥–Ω–∏–π –ø–∞–∫–µ—Ç', cat: 'resources' },
      { id: 'crystals_100', name: '–ö—Ä–∏—Å—Ç–∞–ª–∏ (100)', price: 3.99, emoji: 'üíé', desc: '–í–∞–ª—é—Ç–∞ –¥–ª—è –ø—Ä–µ–º—ñ—É–º-–ø–æ–∫—É–ø–æ–∫', cat: 'resources' },
      { id: 'lives_5', name: '–ñ–∏—Ç—Ç—è (5)', price: 2.49, emoji: '‚ù§Ô∏è', desc: '–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Å–µ—Ä—ñ—é –ø–µ—Ä–µ–º–æ–≥', cat: 'resources' },
      // –ü—ñ–¥–ø–∏—Å–∫–∏ (4‚Äì5 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤)
      { id: 'sub_bronze', name: '–ü—ñ–¥–ø–∏—Å–∫–∞ Bronze ‚Äî 7 –¥–Ω.', price: 4.99, emoji: 'ü•â', desc: '+5% –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤, –±–µ–∑ —Ä–µ–∫–ª–∞–º–∏', cat: 'subs', subscription: { days: 7, tier: 'Bronze' } },
      { id: 'sub_silver', name: '–ü—ñ–¥–ø–∏—Å–∫–∞ Silver ‚Äî 30 –¥–Ω.', price: 9.99, emoji: 'ü•à', desc: '+10% –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤, –∞–≤–∞—Ç–∞—Ä', cat: 'subs', subscription: { days: 30, tier: 'Silver' } },
      { id: 'sub_gold', name: '–ü—ñ–¥–ø–∏—Å–∫–∞ Gold ‚Äî 30 –¥–Ω.', price: 14.99, emoji: 'ü•á', desc: '+20% –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤, —Ä–∞–º–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é', cat: 'subs', subscription: { days: 30, tier: 'Gold' } },
      { id: 'sub_platinum', name: '–ü—ñ–¥–ø–∏—Å–∫–∞ Platinum ‚Äî 90 –¥–Ω.', price: 29.99, emoji: 'üëë', desc: '+30% –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤, VIP-–µ–º–±–ª–µ–º–∞', cat: 'subs', subscription: { days: 90, tier: 'Platinum' } },
      { id: 'sub_season', name: 'Season Pass ‚Äî —Å–µ–∑–æ–Ω', price: 19.99, emoji: 'üé´', desc: '–ï–∫—Å–∫–ª—é–∑–∏–≤–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –Ω–∞–≥–æ—Ä–æ–¥–∏', cat: 'subs', subscription: { days: 60, tier: 'Season' } },
      // –ù–∞–±–æ—Ä–∏
      { id: 'bundle_mega', name: 'Mega Pack', price: 19.99, emoji: 'üéÅ', desc: '–ï–Ω–µ—Ä–≥—ñ—è + –ñ–∏—Ç—Ç—è + –ö—Ä–∏—Å—Ç–∞–ª–∏', cat: 'bundles' },
      { id: 'bundle_starter', name: 'Starter Pack', price: 7.99, emoji: 'üì¶', desc: '–°—Ç–∞—Ä—Ç–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏ –¥–ª—è –Ω–æ–≤–∞—á–∫–∞', cat: 'bundles' },
      // –ö–æ—Å–º–µ—Ç–∏–∫–∞
      { id: 'cos_cardback', name: '–ù–∞–±—ñ—Ä —Å–æ—Ä–æ—á–æ–∫ –∫–∞—Ä—Ç', price: 2.99, emoji: 'üÉè', desc: '–ö–æ—Å–º–µ—Ç–∏—á–Ω–∞ –∑–º—ñ–Ω–∞ –≤–∏–≥–ª—è–¥—É', cat: 'cosmetics' },
      { id: 'cos_emotes', name: '–ï–º–æ—Ü—ñ—ó —á–∞—Ç—É (–Ω–∞–±—ñ—Ä)', price: 1.49, emoji: 'üí¨', desc: '–ñ–µ—Å—Ç–∏–∫–∏ –ø—ñ–¥ —á–∞—Å –º–∞—Ç—á—É', cat: 'cosmetics' },
    ];

    // –°—Ç–∞–Ω
    const state = {
      filter: 'all',
      cart: new Map(), // id -> { product, qty }
      currency: 'USD',
    };

    // –£—Ç–∏–ª—ñ—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
    const fmt = new Intl.NumberFormat('uk-UA', { style: 'currency', currency: 'USD' });

    function price(p) { return fmt.format(p); }

    // DOM
    const grid = document.getElementById('itemsGrid');
    const cartCount = document.getElementById('cartCount');
    const cartSummary = document.getElementById('cartSummary');
    const cartTotal = document.getElementById('cartTotal');
    const cartItems = document.getElementById('cartItems');
    const btnClear = document.getElementById('btnClear');

    function haptic(type = 'light') {
      try { tg?.HapticFeedback?.impactOccurred(type); } catch (_) {}
    }

    function renderProducts() {
      const items = PRODUCTS.filter(p => state.filter === 'all' ? true : p.cat === state.filter);
      grid.innerHTML = '';
      for (const p of items) {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('data-id', p.id);
        card.innerHTML = `
          <div class="icon" aria-hidden="true">${p.emoji}</div>
          <div>
            <div class="name">${p.name}</div>
            <div class="desc">${p.desc}</div>
            <div class="price">${price(p.price)}</div>
          </div>
          <div style="display:grid; gap:8px;">
            <button class="btn btn-add" data-action="add">–ö—É–ø–∏—Ç–∏</button>
            <button class="btn btn-ghost" data-action="more">–î–µ—Ç–∞–ª—ñ</button>
          </div>
        `;
        card.querySelector('[data-action="add"]').addEventListener('click', () => addToCart(p));
        card.querySelector('[data-action="more"]').addEventListener('click', () => showDetails(p));
        grid.appendChild(card);
      }
    }

    function showDetails(p) {
      const text = `${p.name}\n\n${p.desc}\n–¶—ñ–Ω–∞: ${price(p.price)}`;
      if (tg) tg.showPopup({ title: '–î–µ—Ç–∞–ª—ñ', message: text, buttons: [{ id: 'ok', type: 'default', text: 'OK' }] });
      else alert(text);
    }

    function addToCart(product, qty = 1) {
      const row = state.cart.get(product.id) || { product, qty: 0 };
      row.qty += qty;
      state.cart.set(product.id, row);
      haptic('medium');
      updateCartUI();
    }

    function removeFromCart(id) {
      state.cart.delete(id);
      updateCartUI();
    }

    function changeQty(id, delta) {
      const row = state.cart.get(id);
      if (!row) return;
      row.qty += delta;
      if (row.qty <= 0) state.cart.delete(id);
      updateCartUI();
    }

    function getTotals() {
      let items = 0, sum = 0;
      for (const { product, qty } of state.cart.values()) {
        items += qty;
        sum += product.price * qty;
      }
      return { items, sum };
    }

    function updateCartUI() {
      const { items, sum } = getTotals();
      cartCount.textContent = items;
      cartSummary.textContent = items ? `–í –∫–æ—à–∏–∫—É: ${items} –æ–¥.` : '–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π';
      cartTotal.textContent = price(sum);

      cartItems.innerHTML = '';
      for (const { product, qty } of state.cart.values()) {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>${product.emoji} ${product.name}</div>
          <div class="qty" role="group" aria-label="–ö—ñ–ª—å–∫—ñ—Å—Ç—å">
            <button aria-label="–ó–º–µ–Ω—à–∏—Ç–∏" data-delta="-1">‚àí</button>
            <span aria-live="polite">${qty}</span>
            <button aria-label="–ó–±—ñ–ª—å—à–∏—Ç–∏" data-delta="1">+</button>
          </div>
          <button class="btn btn-danger" aria-label="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
        `;
        const [dec, , inc] = row.querySelectorAll('.qty button, .qty span');
        row.querySelector('.btn-danger').addEventListener('click', () => removeFromCart(product.id));
        row.querySelectorAll('.qty button')[0].addEventListener('click', () => changeQty(product.id, -1));
        row.querySelectorAll('.qty button')[1].addEventListener('click', () => changeQty(product.id, 1));
        cartItems.appendChild(row);
      }

      if (tg) {
        if (items > 0) tg.MainButton.show(); else tg.MainButton.hide();
        tg.MainButton.setText('–û–ø–ª–∞—Ç–∏—Ç–∏ ' + price(sum));
      }
    }

    function clearCart() { state.cart.clear(); updateCartUI(); }

    // Checkout ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ —É –±–æ—Ç–∞
    function onCheckout() {
      const payload = [];
      for (const { product, qty } of state.cart.values()) {
        payload.push({ id: product.id, qty, price: product.price });
      }
      const data = {
        type: 'checkout',
        currency: state.currency,
        items: payload,
        total: getTotals().sum,
        ts: Date.now(),
      };
      if (tg) tg.sendData(JSON.stringify(data));
    }

    // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∫—É–ø–æ–∫ (–¥–µ–º–æ) ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ–¥—ñ—é —É –±–æ—Ç–∞
    function onRestore() {
      if (tg) tg.sendData(JSON.stringify({ type: 'restore_purchases', ts: Date.now() }));
    }

    // –û–±—Ä–æ–±–∫–∞ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', 'false'));
        btn.setAttribute('aria-selected', 'true');
        state.filter = btn.dataset.filter;
        renderProducts();
      });
    });

    // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
    btnClear.addEventListener('click', clearCart);
    document.getElementById('btnRestore').addEventListener('click', onRestore);

    // Telegram callbacks
    if (tg) {
      tg.onEvent('mainButtonClicked', onCheckout);
      // –ë–µ–∑–ø–µ—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è —Å–ª—É—Ö–∞—á—ñ–≤ –ø—Ä–∏ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
      window.addEventListener('unload', () => tg.offEvent('mainButtonClicked', onCheckout));
    }

    // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    applyTelegramTheme();
    initTelegram();
    renderProducts();
    updateCartUI();
  </script>
</body>
</html>
